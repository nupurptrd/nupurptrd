// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum EpisodeStatus {
  GENERATING
  READY
  VALIDATION_FAILED
}

enum SeriesStatus {
  DRAFT
  GENERATING
  ACTIVE
  FAILED
}

enum AiCallType {
  ANALYSIS
  SKELETON
  EPISODE_GENERATION
  VALIDATION
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

model Workspace {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  users     WorkspaceUser[]
  books     Book[]
  series    Series[]
  aiCalls   AiCallTrace[]
}
model WorkspaceUser {
  id          String         @id @default(uuid())
  workspaceId String
  userId      String
  role        WorkspaceRole

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([workspaceId, userId])
}
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  workspaces WorkspaceUser[]
}
model Book {
  id          String   @id @default(uuid())
  workspaceId String

  title       String
  author      String?
  language    String
  genre       String?

  contentText String   // FULL BOOK TEXT (post-S3 ingestion)

  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  analysis  BookAnalysis?
  series    Series[]
}
model BookAnalysis {
  id        String @id @default(uuid())
  bookId    String @unique

  summary              String
  totalWordCount       Int
  estimatedReadTimeSec Int

  extractedCharacters  Json   // [{ name, frequency }]
  structuralSegments   Json   // chapters / logical splits

  createdAt DateTime @default(now())

  book Book @relation(fields: [bookId], references: [id])
}
model Series {
  id          String @id @default(uuid())
  workspaceId String
  bookId      String

  title       String
  status      SeriesStatus
  totalEpisodes Int

  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  book      Book      @relation(fields: [bookId], references: [id])

  arcs      SeriesArc[]
  episodes  Episode[]
}
model SeriesArc {
  id        String @id @default(uuid())
  seriesId String

  arcNumber Int
  beatHook        String
  beatEscalation  String
  beatTension     String
  beatRevelation  String
  beatCliffhanger String

  createdAt DateTime @default(now())

  series Series @relation(fields: [seriesId], references: [id])

  @@unique([seriesId, arcNumber])
}
model Episode {
  id        String @id @default(uuid())
  seriesId String
  arcId    String?

  episodeNumber Int
  title         String

  scriptText    String

  durationTargetSec     Int
  estimatedReadTimeSec  Int
  characterCount        Int
  dialogueRatio         Float
  hasCliffhanger        Boolean

  status EpisodeStatus

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  series Series     @relation(fields: [seriesId], references: [id])
  // arc    SeriesArc? @relation(fields: [arcId], references: [id])

  // scenes      Scene[]
  validations EpisodeValidation[]
}
model EpisodeValidation {
  id        String @id @default(uuid())
  episodeId String

  isValid   Boolean
  errors    Json
  warnings  Json

  createdAt DateTime @default(now())

  episode Episode @relation(fields: [episodeId], references: [id])
}
model AiCallTrace {
  id          String @id @default(uuid())
  workspaceId String

  callType    AiCallType
  modelName   String

  prompt      String   // truncated if needed
  tokenEstimate Int

  relatedBookId    String?
  relatedSeriesId  String?
  relatedEpisodeId String?

  createdAt DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
}
